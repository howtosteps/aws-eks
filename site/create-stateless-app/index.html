<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><link rel="canonical" href="https://github.com/howtosteps/aws-eks/site/create-stateless-app/" />
      <link rel="shortcut icon" href="../img/favicon.ico" />
    <title>Create stateless app - Simple AWS EKS Example</title>
    <link rel="stylesheet" href="../css/theme.css" />
    <link rel="stylesheet" href="../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/styles/github.min.css" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "Create stateless app";
        var mkdocs_page_input_path = "create-stateless-app.md";
        var mkdocs_page_url = "/howtosteps/aws-eks/site/create-stateless-app/";
      </script>
    
    <script src="../js/jquery-3.6.0.min.js" defer></script>
    <!--[if lt IE 9]>
      <script src="../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/highlight.min.js"></script>
      <script>hljs.initHighlightingOnLoad();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href=".." class="icon icon-home"> Simple AWS EKS Example
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="..">Introduction</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../prerequisites/">Prerequisites</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../local-environment/">Local environment</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../local-installations/">Local installations</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../create-cluster/">Create cluster</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../extend-cluster/">Extend cluster</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../create-cluster-autoscaler/">Create cluster with autoscaler</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../test-cluster-autoscaler/">Test autoscaler with Nginx</a>
                </li>
              </ul>
              <ul class="current">
                <li class="toctree-l1 current"><a class="reference internal current" href="./">Create stateless app</a>
    <ul class="current">
    <li class="toctree-l2"><a class="reference internal" href="#setup-sample-guestbook-app">Setup sample guestbook app</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#backend-deployment">Backend Deployment</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#redis-leader">Redis leader</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#redis-follower">Redis follower</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#frontend-app">Frontend app</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#guestbook-deployment">Guestbook deployment</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#loadbalancer-service">Loadbalancer service</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#access-from-outside-the-cluster">Access from outside the cluster</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#scale-pods-up-and-down">Scale Pods up and down</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#using-kubectl">Using kubectl</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#using-yaml-file">Using YAML file</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#perform-chaos-testing">Perform chaos testing</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#cleaning-up">Cleaning up</a>
    </li>
    </ul>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../clean-up/">Clean up</a>
                </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="..">Simple AWS EKS Example</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href=".." class="icon icon-home" alt="Docs"></a> &raquo;</li>
      <li>Create stateless app</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="create-stateless-app">Create Stateless App</h1>
<p>In this section we will :</p>
<ul>
<li>Deploy backend resources</li>
<li>Deploy frontend resources</li>
<li>Scale pods up/down </li>
<li>Perform chaos testing</li>
</ul>
<h2 id="setup-sample-guestbook-app">Setup sample guestbook app</h2>
<p>This example is based on <a href="https://github.com/kubernetes/examples/tree/master/guestbook">Kubernetes Guestbook</a>. The application consists of:</p>
<ul>
<li>A Redis backend with a single leader pod for Writes &amp; multiple follower pods for Reads</li>
<li>A frontend app ( Guestbook app ) in PHP loadbalanced to public using a load balancer</li>
<li>Guestbook app reads load balanced to multiple redis followers (reads)</li>
<li>Guestbook app writes directed towards single redis leader (writes)</li>
</ul>
<p><img alt="Screenshot" src="../img/eks-stateless-app.png" /></p>
<h2 id="backend-deployment">Backend Deployment</h2>
<p>Our configuration files for Redis leader/followers includes both Deployment and Services kinds. Deployments and Services are often used in tandem: Deployments working to define the desired state of the application and Services working to make sure communication between almost any kind of resource and the rest of the cluster is stable and adaptable. </p>
<h3 id="redis-leader">Redis leader</h3>
<p>For the Redis leader, first create the Deployment file <code>redis-leader-deployment.yaml</code>. Copy these contents to it : </p>
<pre><code># SOURCE: https://cloud.google.com/kubernetes-engine/docs/tutorials/guestbook
apiVersion: apps/v1
kind: Deployment
metadata:
  name: redis-leader
  labels:
    app: redis
    role: leader
    tier: backend
spec:
  replicas: 1
  selector:
    matchLabels:
      app: redis
  template:
    metadata:
      labels:
        app: redis
        role: leader
        tier: backend
    spec:
      containers:
      - name: leader
        image: &quot;docker.io/redis:6.0.5&quot;
        resources:
          requests:
            cpu: 100m
            memory: 100Mi
        ports:
        - containerPort: 6379
</code></pre>
<p>This tells EKS :</p>
<ul>
<li>The deployment has replica of 1</li>
<li>Specifies the source of image </li>
<li>Set resource requirement for cpu &amp; memory</li>
<li>Set the container port to 6379</li>
</ul>
<p>Now let's create the Service on top of your deployment. Create file <code>redis-leader-service.yaml</code> and copy the following contents to it:</p>
<pre><code># SOURCE: https://cloud.google.com/kubernetes-engine/docs/tutorials/guestbook
apiVersion: v1
kind: Service
metadata:
  name: redis-leader
  labels:
    app: redis
    role: leader
    tier: backend
spec:
  ports:
  - port: 6379
    targetPort: 6379
  selector:
    app: redis
    role: leader
    tier: backend
</code></pre>
<p>Notice that the metadata name and labels are same as the redis-leader Deployment. Here the target port that is exposed is set to 6379. </p>
<p>Now that the configuration files are defined, let's deploy the Redis leader pod :</p>
<pre><code>kubectl apply -f redis-leader-deployment.yaml
</code></pre>
<p>Let's test by checking if the pods were created</p>
<pre><code>kubectl get pods
</code></pre>
<p>Now we apply Redis service on top of this :</p>
<pre><code>kubectl apply -f redis-leader-service.yaml
</code></pre>
<p>Let's test using :</p>
<pre><code>kubectl get service redis-leader
</code></pre>
<h3 id="redis-follower">Redis follower</h3>
<p>For the Redis follower, let's create the Deployment file <code>redis-followers-deployment.yaml</code>. Copy these contents to it : </p>
<pre><code># SOURCE: https://cloud.google.com/kubernetes-engine/docs/tutorials/guestbook
apiVersion: apps/v1
kind: Deployment
metadata:
  name: redis-leader
  labels:
    app: redis
    role: leader
    tier: backend
spec:
  replicas: 1
  selector:
    matchLabels:
      app: redis
  template:
    metadata:
      labels:
        app: redis
        role: leader
        tier: backend
    spec:
      containers:
      - name: leader
        image: &quot;docker.io/redis:6.0.5&quot;
        resources:
          requests:
            cpu: 100m
            memory: 100Mi
        ports:
        - containerPort: 6379
</code></pre>
<p>Just like before we will now create the Service file as <code>redis-follower-service.yaml</code>. Copy the following contents to it : </p>
<pre><code># SOURCE: https://cloud.google.com/kubernetes-engine/docs/tutorials/guestbook
apiVersion: v1
kind: Service
metadata:
  name: redis-follower
  labels:
    app: redis
    role: follower
    tier: backend
spec:
  ports:
    # the port that this service should serve on
  - port: 6379
  selector:
    app: redis
    role: follower
    tier: backend
</code></pre>
<p>Notice the labels that match the Deployment file and the internal port that the redis follower service should run on. </p>
<p>Now that the configuration files are defined, let's deploy the Redis follower pod :</p>
<pre><code>kubectl apply -f redis-followers-deployment.yaml
kubectl apply -f redis-follower-service.yaml
</code></pre>
<p>Let's check the status of Redis followers by running : </p>
<pre><code>kubectl get pods -o wide
</code></pre>
<pre><code>kubectl get service
kubectl describe node &lt;node-name&gt;
</code></pre>
<h2 id="frontend-app">Frontend app</h2>
<p>Now we will deploy the frontend app that will consist of </p>
<ul>
<li>3 replicas of the Guestbook App</li>
<li>ELB LoadBalancer service</li>
</ul>
<h3 id="guestbook-deployment">Guestbook deployment</h3>
<p>We will start with defining the Deployment file for the frontend app. Create <code>frontend-deployment.yaml</code> and copy the following contents : </p>
<pre><code># SOURCE: https://cloud.google.com/kubernetes-engine/docs/tutorials/guestbook
apiVersion: apps/v1
kind: Deployment
metadata:
  name: frontend
spec:
  replicas: 3
  selector:
    matchLabels:
        app: guestbook
        tier: frontend
  template:
    metadata:
      labels:
        app: guestbook
        tier: frontend
    spec:
      containers:
      - name: php-redis
        image: gcr.io/google_samples/gb-frontend:v5
        env:
        - name: GET_HOSTS_FROM
          value: &quot;dns&quot;
        resources:
          requests:
            cpu: 100m
            memory: 100Mi
        ports:
        - containerPort: 80
</code></pre>
<p>This tells EKS to :</p>
<ul>
<li>Generate 3 replicas of the frontend app</li>
<li>Specfiy image source</li>
<li>Set the container resources</li>
<li>Set the container port</li>
</ul>
<p>Let's apply the deployment </p>
<pre><code>kubectl apply -f frontend-deployment.yaml
</code></pre>
<p>Check all the pods for the guestbook app</p>
<pre><code>kubectl get pods
kubectl get pods -l app=guestbook
kubectl get pods -l app=guestbook -l tier=frontend
</code></pre>
<h3 id="loadbalancer-service">Loadbalancer service</h3>
<p>We will now apply the loadbalancer service that allows us to expose all the loadbalanced service to the public. </p>
<p>Create file <code>frontend-service.yaml</code> and copy the following : </p>
<pre><code># SOURCE: https://cloud.google.com/kubernetes-engine/docs/tutorials/guestbook
apiVersion: v1
kind: Service
metadata:
  name: frontend
  labels:
    app: guestbook
    tier: frontend
spec:
  # if your cluster supports it, uncomment the following to automatically create
  # an external load-balanced IP for the frontend service.
  # type: LoadBalancer
  type: LoadBalancer
  ports:
    # the port that this service should serve on
  - port: 80
  selector:
    app: guestbook
    tier: frontend
</code></pre>
<p>Let's apply the loadbalanced service</p>
<pre><code>kubectl apply -f frontend-service.yaml
</code></pre>
<p>Check all services</p>
<pre><code>kubectl get services
kubectl get service frontend 
kubetctl get pods -o wide
kubectl describe service frontend
</code></pre>
<p>Finally check AWS mgm console for the ELB which has been created !</p>
<h3 id="access-from-outside-the-cluster">Access from outside the cluster</h3>
<p>Grab the public DNS of the frontend service LoadBalancer (ELB):</p>
<pre><code>kubectl describe service frontend
</code></pre>
<p>Copy the name and paste it into your browser !!!</p>
<h2 id="scale-pods-up-and-down">Scale Pods up and down</h2>
<p>We can scale pods up and down in the following ways:</p>
<ul>
<li>kubectl</li>
<li>Update YAML file</li>
</ul>
<h3 id="using-kubectl">Using kubectl</h3>
<p>We can scale up and down using kubectl command. To scale up run the following command :  </p>
<pre><code>kubectl scale deployment frontend --replicas=5
</code></pre>
<p>Let's check the pods now</p>
<pre><code>kubectl get pods
</code></pre>
<p>Now let us scale it down</p>
<pre><code>kubectl scale deployment frontend --replicas=3
</code></pre>
<p>You can check pods are terminating by checking the pods</p>
<pre><code>kubectl get pods
</code></pre>
<h3 id="using-yaml-file">Using YAML file</h3>
<p>We can scale the pods by updating the replicas tag in our yaml files. Let's test this out by updating file <code>redis-followers-deployment.yaml</code>. Update the replicas count to 5 as follows :</p>
<pre><code># SOURCE: https://cloud.google.com/kubernetes-engine/docs/tutorials/guestbook
apiVersion: apps/v1
kind: Deployment
metadata:
  name: frontend
spec:
  replicas: 5
  selector:
    matchLabels:
        app: guestbook
        tier: frontend
  template:
    metadata:
      labels:
        app: guestbook
        tier: frontend
    spec:
      containers:
      - name: php-redis
        image: gcr.io/google_samples/gb-frontend:v5
        env:
        - name: GET_HOSTS_FROM
          value: &quot;dns&quot;
        resources:
          requests:
            cpu: 100m
            memory: 100Mi
        ports:
        - containerPort: 80
</code></pre>
<p>Let's apply the new deployment file</p>
<pre><code>kubectl apply -f frontend-deployment.yaml
</code></pre>
<p>Let's check this by running</p>
<pre><code>kubectl get deployment frontend
kubectl get pods
</code></pre>
<h2 id="perform-chaos-testing">Perform chaos testing</h2>
<p>We will demonstrate self-healing mechanism of K8s by:</p>
<ul>
<li>Kill pods</li>
<li>Stop K8s worker node(s)</li>
</ul>
<pre><code>kubectl get pods
kubectl get nodes
</code></pre>
<pre><code>kubectl get pods -o wide
</code></pre>
<p>Now let's delete one of front-end pods</p>
<pre><code>kubectl delete pod &lt;frontend-pod&gt;
</code></pre>
<p>Now check for pods look a the age column. Kubernetes restarts the pod</p>
<pre><code>kubectl get pods -o wide
</code></pre>
<p>Now let's use AWS console to  stop any instance ( AWS &gt; EC2 &gt; instances). You will notice 2 things : 
* Kubernetes will try to recover the nodes
* Kubernetes will reshuffle the nodes if required </p>
<h2 id="cleaning-up">Cleaning up</h2>
<p>Run the following commands to save costs</p>
<pre><code>kubectl delete deployment -l app=redis
kubectl delete service -l app=redis
kubectl delete deployment frontend
kubectl delete service frontend
</code></pre>
              
            </div>
          </div><footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="Footer Navigation">
        <a href="../test-cluster-autoscaler/" class="btn btn-neutral float-left" title="Test autoscaler with Nginx"><span class="icon icon-circle-arrow-left"></span> Previous</a>
        <a href="../clean-up/" class="btn btn-neutral float-right" title="Clean up">Next <span class="icon icon-circle-arrow-right"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
      <span><a href="../test-cluster-autoscaler/" style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
      <span><a href="../clean-up/" style="color: #fcfcfc">Next &raquo;</a></span>
    
  </span>
</div>
    <script>var base_url = '..';</script>
    <script src="../js/theme_extra.js" defer></script>
    <script src="../js/theme.js" defer></script>
      <script src="../search/main.js" defer></script>
    <script defer>
        window.onload = function () {
            SphinxRtdTheme.Navigation.enable(true);
        };
    </script>

</body>
</html>
